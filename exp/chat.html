<!DOCTYPE html>
<html>
<head>
    <title>üîç Test Baserow Connection</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; border-radius: 10px; margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #eee; padding: 10px; overflow: auto; }
    </style>
</head>
<body>
    <h1>üîç Test Baserow Connection</h1>
    
    <div class="card">
        <h3>Step 1: Test Token & Table</h3>
        <button onclick="testConnection()">Test Connection</button>
        <div id="result1"></div>
    </div>
    
    <div class="card">
        <h3>Step 2: Check Table Fields</h3>
        <button onclick="checkFields()">Check Fields</button>
        <div id="result2"></div>
    </div>
    
    <div class="card">
        <h3>Step 3: Create Test Message</h3>
        <button onclick="createTest()">Create Test Message</button>
        <div id="result3"></div>
    </div>
    
    <div class="card">
        <h3>Step 4: View All Messages</h3>
        <button onclick="viewMessages()">View Messages</button>
        <div id="result4"></div>
    </div>

    <script>
        const TOKEN = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
        const TABLE_ID = "778927";
        
        async function testConnection() {
            try {
                const response = await fetch(
                    `https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true&size=1`,
                    {
                        headers: { 'Authorization': `Token ${TOKEN}` }
                    }
                );
                
                const result = document.getElementById('result1');
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="success">‚úÖ Connected! Table has ${data.count || 0} rows</div>`;
                } else {
                    const error = await response.text();
                    result.innerHTML = `<div class="error">‚ùå Failed: ${response.status} ${response.statusText}</div><pre>${error}</pre>`;
                }
            } catch (error) {
                document.getElementById('result1').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function checkFields() {
            try {
                const response = await fetch(
                    `https://api.baserow.io/api/database/fields/table/${TABLE_ID}/`,
                    {
                        headers: { 'Authorization': `Token ${TOKEN}` }
                    }
                );
                
                const result = document.getElementById('result2');
                if (response.ok) {
                    const fields = await response.json();
                    let html = `<div class="success">‚úÖ Found ${fields.length} fields:</div><ul>`;
                    fields.forEach(field => {
                        html += `<li><strong>${field.name}</strong>: ${field.type} (ID: ${field.id})</li>`;
                    });
                    html += '</ul>';
                    result.innerHTML = html;
                } else {
                    const error = await response.text();
                    result.innerHTML = `<div class="error">‚ùå Failed: ${response.status}</div><pre>${error}</pre>`;
                }
            } catch (error) {
                document.getElementById('result2').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function createTest() {
            try {
                // Simple test data - adjust based on your actual fields
                const testData = {
                    room_id: "test-room",
                    username: "tester",
                    encrypted_data: "VGVzdCBtZXNzYWdl", // "Test message" in base64
                    encryption_key: "dGVzdC1rZXk=" // "test-key" in base64
                };
                
                const response = await fetch(
                    `https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testData)
                    }
                );
                
                const result = document.getElementById('result3');
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="success">‚úÖ Created message! ID: ${data.id}</div>`;
                } else {
                    const error = await response.text();
                    result.innerHTML = `<div class="error">‚ùå Failed: ${response.status}</div><pre>${error}</pre>`;
                }
            } catch (error) {
                document.getElementById('result3').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function viewMessages() {
            try {
                const response = await fetch(
                    `https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true&size=10`,
                    {
                        headers: { 'Authorization': `Token ${TOKEN}` }
                    }
                );
                
                const result = document.getElementById('result4');
                if (response.ok) {
                    const data = await response.json();
                    result.innerHTML = `<div class="success">‚úÖ Found ${data.results?.length || 0} messages:</div>`;
                    
                    if (data.results && data.results.length > 0) {
                        let html = '<pre>';
                        data.results.forEach((msg, i) => {
                            html += `\n=== Message ${i+1} ===\n`;
                            for (const [key, value] of Object.entries(msg)) {
                                html += `${key}: ${value}\n`;
                            }
                        });
                        html += '</pre>';
                        result.innerHTML += html;
                    }
                } else {
                    const error = await response.text();
                    result.innerHTML = `<div class="error">‚ùå Failed: ${response.status}</div><pre>${error}</pre>`;
                }
            } catch (error) {
                document.getElementById('result4').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Run tests automatically
        window.onload = function() {
            setTimeout(testConnection, 500);
            setTimeout(checkFields, 1000);
        };
    </script>
</body>
</html>