<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê Fixed Sync - Encrypted Chat</title>
    <style>
        /* Keep all the previous styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ... (keep all previous styles) ... */
        
        /* Add this new style for test button */
        .test-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9em;
        }
        
        .test-btn:hover {
            background: #0da271;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Keep all previous HTML structure -->
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-shield-alt"></i>
                <span>Fixed Sync Chat</span>
            </div>
            <p class="tagline">Now with working Baserow sync!</p>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="panel" id="authPanel">
                    <h3><i class="fas fa-user-lock"></i> Authentication</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="username" placeholder="Enter your name" value="TestUser">
                    </div>
                    <div class="form-group">
                        <label>Encryption Key</label>
                        <input type="password" id="encryptionKey" placeholder="Enter encryption key" value="test123">
                    </div>
                    <button class="btn btn-primary" onclick="login()" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Start Chatting
                    </button>
                    <!-- TEST BUTTON -->
                    <button class="test-btn" onclick="testBaserowConnection()" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-vial"></i> Test Baserow Connection
                    </button>
                </div>
                
                <div class="panel" id="roomsPanel" style="display: none;">
                    <h3><i class="fas fa-door-closed"></i> Rooms</h3>
                    <div class="room-list" id="roomList"></div>
                    <div style="margin-top: 15px;">
                        <input type="text" id="newRoomName" placeholder="New room name" style="width: 100%; margin-bottom: 10px;">
                        <button class="btn btn-secondary" onclick="createRoom()" style="width: 100%;">
                            <i class="fas fa-plus"></i> Create Room
                        </button>
                    </div>
                </div>
                
                <div class="panel" id="storagePanel" style="display: none;">
                    <h3><i class="fas fa-database"></i> Sync Status</h3>
                    <div id="syncInfo">
                        <p>Last Sync: <span id="lastSyncTime">Never</span></p>
                        <p>Sync Status: <span id="syncStatusText">‚ùì</span></p>
                        <p>Messages: <span id="messageCount">0</span> local</p>
                    </div>
                    <button class="btn btn-secondary" onclick="forceSync()" style="width: 100%; margin-top: 10px;">
                        <i class="fas fa-sync"></i> Force Sync Now
                    </button>
                </div>
            </div>
            
            <div class="chat-area" id="chatArea" style="display: none;">
                <div class="chat-header">
                    <h2><i class="fas fa-hashtag"></i> <span id="currentRoomName">Select a Room</span></h2>
                    <div class="status" id="connectionStatus">
                        <i class="fas fa-circle"></i>
                        <span>Checking connection...</span>
                    </div>
                </div>
                
                <div class="messages-container" id="messagesContainer">
                    <div class="message system">
                        <div class="message-header">
                            <span class="sender">System</span>
                            <span class="time">Just now</span>
                        </div>
                        <div class="message-content">
                            Welcome! Testing Baserow sync...
                        </div>
                    </div>
                </div>
                
                <div class="message-input">
                    <div class="input-group">
                        <textarea id="messageInput" placeholder="Type your message..." rows="2"></textarea>
                        <button class="btn btn-primary" id="sendBtn">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            <i class="fas fa-info-circle"></i> <span id="syncHint">Click "Test Connection" first</span>
                        </div>
                        <div style="font-size: 0.85em; color: #94a3b8;">
                            <span id="charCount">0</span>/1000
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="sync-status" id="globalSyncStatus">
            <i class="fas fa-sync"></i>
            <span>Baserow: Testing...</span>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const BASEROW_CONFIG = {
            TOKEN: "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw",
            BASE_URL: "https://api.baserow.io/api",
            DATABASE_ID: "340628",
            ROOMS_TABLE_ID: "778590",
            MESSAGES_TABLE_ID: "778592"
        };

        // ================= STATE =================
        let state = {
            currentUser: null,
            encryptionKey: null,
            currentRoom: null,
            rooms: [],
            messages: new Map(),
            isOnline: false,
            connectionTested: false
        };

        // ================= TEST CONNECTION =================
        async function testBaserowConnection() {
            console.log('üîç Testing Baserow connection...');
            updateStatus('Testing connection to Baserow...', 'warning');
            
            try {
                // Test 1: Check if we can access the messages table
                console.log('Testing messages table access...');
                const testUrl = `https://api.baserow.io/api/database/rows/table/${BASEROW_CONFIG.MESSAGES_TABLE_ID}/?user_field_names=true&size=1`;
                
                const response = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Token ${BASEROW_CONFIG.TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    
                    if (response.status === 401) {
                        throw new Error('‚ùå Invalid API token. Check your Baserow token.');
                    } else if (response.status === 404) {
                        throw new Error('‚ùå Table not found. Check table ID: ' + BASEROW_CONFIG.MESSAGES_TABLE_ID);
                    } else {
                        throw new Error(`‚ùå HTTP ${response.status}: ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                console.log('‚úÖ Connection successful! Data:', data);
                
                // Test 2: Try to create a test message
                console.log('Testing message creation...');
                const testMessage = {
                    room: "test_room",
                    user: "tester",
                    type: "text",
                    cipher: "dGVzdCBtZXNzYWdl", // "test message" in base64
                    iv: "dGVzdCBpbg==" // "test iv" in base64
                };
                
                const createResponse = await fetch(
                    `https://api.baserow.io/api/database/rows/table/${BASEROW_CONFIG.MESSAGES_TABLE_ID}/?user_field_names=true`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Token ${BASEROW_CONFIG.TOKEN}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(testMessage)
                    }
                );
                
                console.log('Create response:', createResponse.status);
                
                if (createResponse.ok) {
                    const result = await createResponse.json();
                    console.log('‚úÖ Message created successfully! ID:', result.id);
                    
                    // Delete the test message
                    await fetch(
                        `https://api.baserow.io/api/database/rows/table/${BASEROW_CONFIG.MESSAGES_TABLE_ID}/${result.id}/`,
                        {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Token ${BASEROW_CONFIG.TOKEN}`
                            }
                        }
                    );
                    console.log('‚úÖ Test message cleaned up');
                    
                    state.isOnline = true;
                    state.connectionTested = true;
                    
                    updateStatus('‚úÖ Baserow connection successful! Ready to sync.', 'success');
                    document.getElementById('syncHint').innerHTML = '<i class="fas fa-check-circle"></i> Baserow connected';
                    document.getElementById('syncStatusText').textContent = '‚úÖ Connected';
                    
                    // Enable login
                    document.getElementById('username').disabled = false;
                    document.getElementById('encryptionKey').disabled = false;
                    
                } else {
                    const errorText = await createResponse.text();
                    console.error('Create failed:', errorText);
                    
                    // Check if it's a field validation error
                    if (createResponse.status === 400 && errorText.includes('field')) {
                        throw new Error('‚ùå Field validation failed. Check your table columns match: room, user, type, cipher, iv');
                    }
                    throw new Error(`‚ùå Cannot create messages: HTTP ${createResponse.status}`);
                }
                
            } catch (error) {
                console.error('Connection test failed:', error);
                updateStatus(error.message, 'error');
                document.getElementById('syncStatusText').textContent = '‚ùå Failed';
                state.isOnline = false;
                
                // Show detailed error
                alert(`Connection test failed:\n\n${error.message}\n\n1. Check API token is valid\n2. Check table IDs are correct\n3. Check table has required fields:\n   - room (Text)\n   - user (Text)\n   - type (Single select)\n   - cipher (Long text)\n   - iv (Text)`);
            }
        }

        // ================= FIXED BASEROW REQUEST =================
        async function baserowRequest(endpoint, method = 'GET', data = null) {
            console.log(`üì§ ${method} ${endpoint}`, data);
            
            const headers = {
                'Authorization': `Token ${BASEROW_CONFIG.TOKEN}`,
                'Content-Type': 'application/json'
            };

            const options = {
                method,
                headers
            };

            if (data && method !== 'GET') {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`${BASEROW_CONFIG.BASE_URL}${endpoint}`, options);
                console.log(`üì• Response: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                    
                    // Parse error for better message
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        if (errorJson.error) errorMessage = errorJson.error;
                        if (errorJson.detail) errorMessage = errorJson.detail;
                    } catch (e) {
                        errorMessage = errorText.substring(0, 100);
                    }
                    
                    throw new Error(errorMessage);
                }
                
                const responseData = await response.json();
                console.log('‚úÖ Request successful:', responseData);
                return responseData;
                
            } catch (error) {
                console.error('‚ùå Request failed:', error);
                throw error;
            }
        }

        // ================= FIXED SYNC FUNCTION =================
        async function syncMessageToBaserow(messageData) {
            if (!state.isOnline) {
                console.log('‚ö†Ô∏è Offline - skipping sync');
                return false;
            }
            
            console.log('üîÑ Syncing message to Baserow:', messageData);
            
            try {
                // Clean the data - ensure it matches table structure
                const cleanData = {
                    room: String(messageData.room || 'general'),
                    user: String(messageData.user || 'unknown'),
                    type: messageData.type || 'text',
                    cipher: String(messageData.cipher),
                    iv: String(messageData.iv)
                };
                
                console.log('üì¶ Cleaned data for Baserow:', cleanData);
                
                const result = await baserowRequest(
                    `/database/rows/table/${BASEROW_CONFIG.MESSAGES_TABLE_ID}/?user_field_names=true`,
                    'POST',
                    cleanData
                );
                
                console.log('‚úÖ Sync successful! Message ID:', result.id);
                
                // Update UI
                updateSyncStatus(true);
                return true;
                
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                updateSyncStatus(false, error.message);
                return false;
            }
        }

        // ================= MESSAGE FUNCTIONS =================
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            
            if (!messageText) return;
            
            console.log('üí¨ Sending message:', messageText.substring(0, 50));
            
            // Disable input while processing
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            try {
                // 1. Encrypt the message
                const encrypted = await encryptMessage(messageText);
                console.log('üîê Encrypted successfully');
                
                // 2. Create message object
                const messageObj = {
                    room: state.currentRoom || 'general',
                    user: state.currentUser,
                    type: "text",
                    cipher: encrypted.cipher,
                    iv: encrypted.iv,
                    decryptedContent: messageText,
                    timestamp: new Date().toISOString(),
                    localId: Date.now()
                };
                
                // 3. Save locally
                saveMessageLocally(messageObj);
                console.log('üíæ Saved locally');
                
                // 4. Clear input
                input.value = '';
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                updateCharCount();
                
                // 5. Try to sync to Baserow
                if (state.isOnline) {
                    console.log('üîÑ Attempting Baserow sync...');
                    const syncResult = await syncMessageToBaserow({
                        room: messageObj.room,
                        user: messageObj.user,
                        type: messageObj.type,
                        cipher: messageObj.cipher,
                        iv: messageObj.iv
                    });
                    
                    if (syncResult) {
                        addSystemMessage('‚úÖ Message sent and synced to Baserow!');
                    } else {
                        addSystemMessage('‚ö†Ô∏è Message saved locally (sync failed)');
                    }
                } else {
                    addSystemMessage('üì¥ Message saved locally (offline)');
                }
                
            } catch (error) {
                console.error('‚ùå Send failed:', error);
                input.disabled = false;
                document.getElementById('sendBtn').disabled = false;
                addSystemMessage(`‚ùå Error: ${error.message}`);
            }
        }

        function saveMessageLocally(message) {
            const roomId = message.room;
            
            if (!state.messages.has(roomId)) {
                state.messages.set(roomId, []);
            }
            
            const roomMessages = state.messages.get(roomId);
            roomMessages.push(message);
            
            // Update UI if this is the current room
            if (roomId === state.currentRoom) {
                displayMessage(message);
            }
            
            // Update count
            updateMessageCount();
        }

        // ================= ENCRYPTION FUNCTIONS =================
        async function deriveKey(password, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey(
                "raw",
                encoder.encode(password),
                { name: "PBKDF2" },
                false,
                ["deriveKey"]
            );

            return await window.crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: encoder.encode(salt),
                    iterations: 100000,
                    hash: "SHA-256"
                },
                keyMaterial,
                { name: "AES-CBC", length: 256 },
                false,
                ["encrypt", "decrypt"]
            );
        }

        async function encryptMessage(text) {
            if (!state.encryptionKey) throw new Error("No encryption key");
            
            const iv = window.crypto.getRandomValues(new Uint8Array(16));
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            
            const encrypted = await window.crypto.subtle.encrypt(
                { name: "AES-CBC", iv },
                state.encryptionKey,
                data
            );
            
            return {
                cipher: arrayBufferToBase64(encrypted),
                iv: arrayBufferToBase64(iv)
            };
        }

        // ================= UTILITY FUNCTIONS =================
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('connectionStatus');
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-circle',
                info: 'fa-info-circle'
            };
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#60a5fa'
            };
            
            statusEl.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}"></i>
                <span>${message}</span>
            `;
            
            // Update global status
            if (type === 'success') {
                document.getElementById('globalSyncStatus').innerHTML = `
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    <span>Baserow: Connected</span>
                `;
            }
        }

        function updateSyncStatus(success, errorMessage = '') {
            const now = new Date();
            document.getElementById('lastSyncTime').textContent = 
                now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (success) {
                document.getElementById('syncStatusText').innerHTML = 
                    '<span style="color: #10b981;">‚úÖ Synced</span>';
            } else {
                document.getElementById('syncStatusText').innerHTML = 
                    `<span style="color: #ef4444;">‚ùå Failed: ${errorMessage.substring(0, 30)}...</span>`;
            }
        }

        function updateMessageCount() {
            let total = 0;
            state.messages.forEach(msgs => total += msgs.length);
            document.getElementById('messageCount').textContent = total;
        }

        function updateCharCount() {
            const input = document.getElementById('messageInput');
            const count = input.value.length;
            document.getElementById('charCount').textContent = count;
        }

        // ================= UI FUNCTIONS =================
        async function login() {
            const username = document.getElementById('username').value.trim();
            const key = document.getElementById('encryptionKey').value;
            
            if (!username || !key) {
                alert('Please enter both username and encryption key');
                return;
            }
            
            if (!state.connectionTested) {
                const proceed = confirm('‚ö†Ô∏è Baserow connection not tested. Test connection first?');
                if (proceed) {
                    testBaserowConnection();
                }
                return;
            }
            
            try {
                // Derive encryption key
                const salt = `securechat_${username}`;
                state.encryptionKey = await deriveKey(key, salt);
                state.currentUser = username;
                
                // Update UI
                document.getElementById('authPanel').style.display = 'none';
                document.getElementById('roomsPanel').style.display = 'block';
                document.getElementById('storagePanel').style.display = 'block';
                document.getElementById('chatArea').style.display = 'flex';
                
                // Join general room
                joinRoom('general', 'General Chat');
                
                updateStatus('‚úÖ Logged in as ' + username, 'success');
                
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        function joinRoom(roomId, roomName) {
            state.currentRoom = roomId;
            document.getElementById('currentRoomName').textContent = roomName;
            
            // Load messages for this room
            loadMessages();
        }

        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            const roomMessages = state.messages.get(state.currentRoom) || [];
            
            if (roomMessages.length === 0) {
                addSystemMessage('No messages yet. Start chatting!');
            } else {
                roomMessages.forEach(msg => displayMessage(msg));
            }
        }

        function displayMessage(message) {
            const container = document.getElementById('messagesContainer');
            const isSent = message.user === state.currentUser;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            
            const time = message.timestamp ? 
                new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) :
                'Just now';
            
            msgDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender">${escapeHtml(message.user)}</span>
                    <span class="time">${time}</span>
                </div>
                <div class="message-content">${escapeHtml(message.decryptedContent || '[Encrypted]')}</div>
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(content) {
            const container = document.getElementById('messagesContainer');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message system';
            
            msgDiv.innerHTML = `
                <div class="message-header">
                    <span class="sender">System</span>
                    <span class="time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="message-content">${escapeHtml(content)}</div>
            `;
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function forceSync() {
            if (!state.isOnline) {
                alert('Not connected to Baserow. Test connection first.');
                return;
            }
            
            const roomMessages = state.messages.get(state.currentRoom) || [];
            if (roomMessages.length === 0) {
                alert('No messages to sync.');
                return;
            }
            
            // Get the latest message
            const latestMessage = roomMessages[roomMessages.length - 1];
            
            addSystemMessage('üîÑ Attempting to sync latest message...');
            
            const success = await syncMessageToBaserow({
                room: latestMessage.room,
                user: latestMessage.user,
                type: latestMessage.type,
                cipher: latestMessage.cipher,
                iv: latestMessage.iv
            });
            
            if (success) {
                addSystemMessage('‚úÖ Latest message synced successfully!');
            }
        }

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Chat application starting...');
            
            // Setup message input
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', updateCharCount);
            
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Setup send button
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            
            // Setup login on Enter
            document.getElementById('encryptionKey').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // Initial status
            updateStatus('Click "Test Connection" to begin', 'info');
            
            console.log('‚úÖ Application ready. Click "Test Connection" first.');
        });
    </script>
</body>
</html>