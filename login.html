<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Inventory Login</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary: #4361ee;
  --primary-dark: #3a56d4;
  --secondary: #7209b7;
  --success: #4cc9f0;
  --light: #f8f9fa;
  --dark: #212529;
  --gray: #6c757d;
  --white: #ffffff;
  --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  padding: 20px;
}

.container {
  background: var(--white);
  padding: 40px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  width: 100%;
  max-width: 450px;
  position: relative;
  overflow: hidden;
}

.container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(to right, var(--primary), var(--secondary));
}

h2 {
  text-align: center;
  color: var(--dark);
  margin-bottom: 30px;
  font-weight: 600;
  font-size: 28px;
}

.input-group {
  position: relative;
  margin-bottom: 20px;
}

input, select, textarea {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  font-size: 16px;
  transition: var(--transition);
  background-color: var(--white);
  font-family: inherit;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
}

label {
  position: absolute;
  top: 50%;
  left: 16px;
  transform: translateY(-50%);
  color: var(--gray);
  pointer-events: none;
  transition: var(--transition);
  background: var(--white);
  padding: 0 4px;
}

textarea + label {
  top: 25px;
}

input:focus + label,
input:not(:placeholder-shown) + label,
textarea:focus + label,
textarea:not(:placeholder-shown) + label {
  top: 0;
  font-size: 12px;
  color: var(--primary);
}

button {
  width: 100%;
  padding: 14px;
  background: var(--primary);
  color: var(--white);
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  margin-top: 10px;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 50px;
}

button:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

button:disabled {
  background: #b8c2cc;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--white);
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

.link {
  text-align: center;
  margin-top: 20px;
  color: var(--gray);
}

.link a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 500;
  transition: var(--transition);
}

.link a:hover {
  color: var(--primary-dark);
  text-decoration: underline;
}

.notice {
  text-align: center;
  margin-top: 15px;
  padding: 10px;
  border-radius: 8px;
  font-weight: 500;
}

.error {
  color: #e63946;
  background-color: rgba(230, 57, 70, 0.1);
}

.success {
  color: #2a9d8f;
  background-color: rgba(42, 157, 143, 0.1);
}

/* Popup Styles */
.popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: var(--transition);
}

.popup-overlay.active {
  opacity: 1;
  visibility: visible;
}

.popup {
  background: var(--white);
  padding: 30px;
  border-radius: 16px;
  box-shadow: var(--shadow);
  max-width: 400px;
  width: 90%;
  text-align: center;
  transform: translateY(20px);
  transition: var(--transition);
}

.popup-overlay.active .popup {
  transform: translateY(0);
}

.popup-icon {
  font-size: 48px;
  color: #2a9d8f;
  margin-bottom: 15px;
}

.popup h3 {
  color: var(--dark);
  margin-bottom: 10px;
}

.popup p {
  color: var(--gray);
  margin-bottom: 20px;
}

.popup-btn {
  background: var(--primary);
  color: var(--white);
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
}

.popup-btn:hover {
  background: var(--primary-dark);
}

/* Animation for form switching */
.form-container {
  transition: var(--transition);
}

.hidden {
  display: none;
  opacity: 0;
  transform: translateX(20px);
}

.visible {
  display: block;
  opacity: 1;
  transform: translateX(0);
}

/* Password toggle button */
.password-toggle {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--gray);
  cursor: pointer;
  width: auto;
  height: auto;
  padding: 0;
  margin: 0;
}

.password-toggle:hover {
  color: var(--primary);
  background: none;
  transform: translateY(-50%);
  box-shadow: none;
}

/* Password validation styles */
.password-rules {
  margin-top: 5px;
  font-size: 12px;
  color: var(--gray);
  display: none; /* Hidden by default */
}

.password-rule {
  display: flex;
  align-items: center;
  margin-bottom: 5px;
}

.password-rule i {
  margin-right: 5px;
  font-size: 10px;
}

.rule-valid {
  color: #2a9d8f;
}

.rule-invalid {
  color: #e63946;
}

/* Textarea specific styles */
textarea {
  resize: vertical;
  min-height: 80px;
}

/* Password match indicator */
.password-match {
  margin-top: 5px;
  font-size: 12px;
  display: flex;
  align-items: center;
}

.password-match i {
  margin-right: 5px;
  font-size: 10px;
}

.match-valid {
  color: #2a9d8f;
}

.match-invalid {
  color: #e63946;
}

/* Shop Selection Styles */
.shop-selection {
  margin: 20px 0;
}

.shop-option {
  display: flex;
  align-items: center;
  padding: 12px;
  border: 2px solid #e9ecef;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: var(--transition);
}

.shop-option:hover {
  border-color: var(--primary);
  background-color: rgba(67, 97, 238, 0.05);
}

.shop-option.selected {
  border-color: var(--primary);
  background-color: rgba(67, 97, 238, 0.1);
}

.shop-radio {
  margin-right: 10px;
}

.shop-details {
  flex-grow: 1;
}

.shop-name {
  font-weight: 600;
  color: var(--dark);
}

.shop-address {
  font-size: 14px;
  color: var(--gray);
  margin-top: 4px;
}

/* Mobile validation indicator */
.mobile-validation {
  margin-top: 5px;
  font-size: 12px;
  display: flex;
  align-items: center;
}

.mobile-validation i {
  margin-right: 5px;
  font-size: 10px;
}

.mobile-valid {
  color: #2a9d8f;
}

.mobile-invalid {
  color: #e63946;
}

/* Responsive adjustments */
@media (max-width: 480px) {
  .container {
    padding: 30px 20px;
  }
  
  h2 {
    font-size: 24px;
  }
}
</style>
</head>
<body>
<div class="container">
  <h2><i class="fas fa-boxes"></i> Inventory Login</h2>
  
  <!-- LOGIN FORM -->
  <div id="loginForm" class="form-container visible">
    <div class="input-group">
      <input type="text" id="mobile" placeholder=" " maxlength="10" tabindex="1">
      <label for="mobile"><i class="fas fa-mobile-alt"></i> Mobile Number (10 digits)</label>
    </div>
    
    <div class="input-group">
      <input type="password" id="password" placeholder=" " tabindex="2">
      <label for="password"><i class="fas fa-lock"></i> Password</label>
      <button type="button" class="password-toggle" onclick="togglePassword('password')" tabindex="3">
        <i class="fas fa-eye"></i>
      </button>
    </div>
    
    <button id="loginBtn" onclick="login()" tabindex="4">
      <span id="loginText"><i class="fas fa-sign-in-alt"></i> Login</span>
    </button>
    
    <div class="link">
      <p>Don't have an account? <a href="#" onclick="showRegister()" tabindex="5">Register</a></p>
    </div>
    
    <div id="msg" class="notice"></div>
  </div>

  <!-- REGISTRATION FORM -->
  <div id="registerForm" class="form-container hidden">
    <!-- Personal Information -->
    <div class="input-group">
      <input type="text" id="rname" placeholder=" " tabindex="1">
      <label for="rname"><i class="fas fa-user"></i> Full Name</label>
    </div>
    
    <div class="input-group">
      <input type="text" id="rmobile" placeholder=" " maxlength="10" tabindex="2" onblur="checkMobileAvailability()">
      <label for="rmobile"><i class="fas fa-mobile-alt"></i> Mobile Number (10 digits)</label>
      
      <!-- Mobile availability indicator -->
      <div id="mobileValidation" class="mobile-validation" style="display: none;">
        <i id="mobileIcon" class="fas fa-times-circle mobile-invalid"></i>
        <span id="mobileText">Mobile number already registered</span>
      </div>
    </div>
    
    <!-- Shop Information -->
    <div class="input-group">
      <input type="text" id="rshopname" placeholder=" " tabindex="3">
      <label for="rshopname"><i class="fas fa-store"></i> Shop Name</label>
    </div>
    
    <div class="input-group">
      <textarea id="raddress" placeholder=" " tabindex="4"></textarea>
      <label for="raddress"><i class="fas fa-map-marker-alt"></i> Shop Address</label>
    </div>
    
    <!-- Password Section -->
    <div class="input-group">
      <input type="password" id="rpassword" placeholder=" " onkeyup="validatePassword()" tabindex="5">
      <label for="rpassword"><i class="fas fa-lock"></i> Password</label>
      <button type="button" class="password-toggle" onclick="togglePassword('rpassword')" tabindex="6">
        <i class="fas fa-eye"></i>
      </button>
      
      <!-- Password validation rules - only shown when not obeyed -->
      <div id="passwordRules" class="password-rules">
        <div class="password-rule">
          <i id="lengthRule" class="fas fa-times-circle rule-invalid"></i>
          <span>At least 8 characters</span>
        </div>
        <div class="password-rule">
          <i id="uppercaseRule" class="fas fa-times-circle rule-invalid"></i>
          <span>At least one uppercase letter</span>
        </div>
        <div class="password-rule">
          <i id="lowercaseRule" class="fas fa-times-circle rule-invalid"></i>
          <span>At least one lowercase letter</span>
        </div>
        <div class="password-rule">
          <i id="numberRule" class="fas fa-times-circle rule-invalid"></i>
          <span>At least one number</span>
        </div>
        <div class="password-rule">
          <i id="specialRule" class="fas fa-times-circle rule-invalid"></i>
          <span>At least one special character</span>
        </div>
      </div>
    </div>
    
    <div class="input-group">
      <input type="password" id="rconfirmpassword" placeholder=" " onkeyup="checkPasswordMatch()" tabindex="7">
      <label for="rconfirmpassword"><i class="fas fa-lock"></i> Re-enter Password</label>
      <button type="button" class="password-toggle" onclick="togglePassword('rconfirmpassword')" tabindex="8">
        <i class="fas fa-eye"></i>
      </button>
      
      <!-- Password match indicator -->
      <div id="passwordMatch" class="password-match" style="display: none;">
        <i id="matchIcon" class="fas fa-times-circle match-invalid"></i>
        <span id="matchText">Passwords do not match</span>
      </div>
    </div>
    
    <!-- Hidden Role section -->
    <div class="input-group" style="display: none;">
      <select id="rrole">
        <option value="Manager">Manager</option>
      </select>
    </div>
    
    <button id="registerBtn" onclick="register()" tabindex="9">
      <span id="registerText"><i class="fas fa-user-plus"></i> Register</span>
    </button>
    
    <div class="link">
      <p>Already have an account? <a href="#" onclick="showLogin()" tabindex="10">Login</a></p>
    </div>
    
    <div id="rmsg" class="notice"></div>
  </div>
</div>

<!-- Success Popup -->
<div class="popup-overlay" id="successPopup">
  <div class="popup">
    <div class="popup-icon"><i class="fas fa-check-circle"></i></div>
    <h3>Registration Successful!</h3>
    <p>Your account has been created successfully. You can now login with your credentials.</p>
    <button class="popup-btn" onclick="closePopup()" tabindex="1">Continue to Login</button>
  </div>
</div>

<!-- Shop Selection Popup -->
<div class="popup-overlay" id="shopSelectionPopup">
  <div class="popup">
    <div class="popup-icon"><i class="fas fa-store"></i></div>
    <h3>Select Your Shop</h3>
    <p>This mobile number is registered with multiple shops. Please select which shop you want to access:</p>
    
    <div id="shopOptions" class="shop-selection">
      <!-- Shop options will be dynamically inserted here -->
    </div>
    
    <button class="popup-btn" onclick="confirmShopSelection()" tabindex="1">Continue</button>
  </div>
</div>

<script>
const API_KEY = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
const TABLE_ID = 729979;
const BASE_URL = "https://api.baserow.io/api/database/rows/table/";

// Variables to store user data for shop selection
let matchingUsers = [];
let selectedShopId = "";
let isMobileAvailable = false;

// Check if user is already logged in
window.onload = function() {
  const shopIdTag = localStorage.getItem("ShopIDTag");
  if (shopIdTag) {
    window.location.href = "app.html";
  }
};

function showRegister() {
  document.getElementById('loginForm').classList.remove('visible');
  document.getElementById('loginForm').classList.add('hidden');
  
  setTimeout(() => {
    document.getElementById('registerForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('visible');
    // Focus on first field when switching to register form
    document.getElementById('rname').focus();
  }, 150);
}

function showLogin() {
  document.getElementById('registerForm').classList.remove('visible');
  document.getElementById('registerForm').classList.add('hidden');
  
  setTimeout(() => {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('loginForm').classList.add('visible');
    // Focus on first field when switching to login form
    document.getElementById('mobile').focus();
  }, 150);
}

function showPopup() {
  document.getElementById('successPopup').classList.add('active');
}

function closePopup() {
  document.getElementById('successPopup').classList.remove('active');
  showLogin();
}

// Toggle password visibility
function togglePassword(fieldId) {
  const passwordField = document.getElementById(fieldId);
  const toggleButton = passwordField.nextElementSibling;
  const icon = toggleButton.querySelector('i');
  
  if (passwordField.type === 'password') {
    passwordField.type = 'text';
    icon.className = 'fas fa-eye-slash';
  } else {
    passwordField.type = 'password';
    icon.className = 'fas fa-eye';
  }
}

// Password validation function
function validatePassword() {
  const password = document.getElementById('rpassword').value;
  const passwordRules = document.getElementById('passwordRules');
  
  // Validation rules
  const hasMinLength = password.length >= 8;
  const hasUppercase = /[A-Z]/.test(password);
  const hasLowercase = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);
  const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
  
  // Update UI for each rule
  updateRuleIcon('lengthRule', hasMinLength);
  updateRuleIcon('uppercaseRule', hasUppercase);
  updateRuleIcon('lowercaseRule', hasLowercase);
  updateRuleIcon('numberRule', hasNumber);
  updateRuleIcon('specialRule', hasSpecial);
  
  // Show password rules only if password is not empty and not all rules are met
  if (password.length > 0 && !(hasMinLength && hasUppercase && hasLowercase && hasNumber && hasSpecial)) {
    passwordRules.style.display = 'block';
  } else {
    passwordRules.style.display = 'none';
  }
  
  // Return overall validation status
  return hasMinLength && hasUppercase && hasLowercase && hasNumber && hasSpecial;
}

function updateRuleIcon(ruleId, isValid) {
  const ruleIcon = document.getElementById(ruleId);
  if (isValid) {
    ruleIcon.className = 'fas fa-check-circle rule-valid';
  } else {
    ruleIcon.className = 'fas fa-times-circle rule-invalid';
  }
}

// Check if passwords match
function checkPasswordMatch() {
  const password = document.getElementById('rpassword').value;
  const confirmPassword = document.getElementById('rconfirmpassword').value;
  const passwordMatch = document.getElementById('passwordMatch');
  
  if (confirmPassword.length === 0) {
    passwordMatch.style.display = 'none';
    return false;
  }
  
  const passwordsMatch = password === confirmPassword;
  
  if (passwordsMatch) {
    document.getElementById('matchIcon').className = 'fas fa-check-circle match-valid';
    document.getElementById('matchText').textContent = 'Passwords match';
    document.getElementById('matchText').className = 'match-valid';
  } else {
    document.getElementById('matchIcon').className = 'fas fa-times-circle match-invalid';
    document.getElementById('matchText').textContent = 'Passwords do not match';
    document.getElementById('matchText').className = 'match-invalid';
  }
  
  passwordMatch.style.display = 'block';
  return passwordsMatch;
}

// Check mobile number availability
async function checkMobileAvailability() {
  const mobile = document.getElementById('rmobile').value.trim();
  const mobileValidation = document.getElementById('mobileValidation');
  
  if (mobile.length !== 10 || isNaN(mobile)) {
    mobileValidation.style.display = 'none';
    isMobileAvailable = false;
    return;
  }
  
  try {
    const res = await fetch(`${BASE_URL}${TABLE_ID}/?user_field_names=true`, {
      headers: { Authorization: `Token ${API_KEY}` }
    });
    const data = await res.json();
    
    // Check if mobile number already exists in Username column
    const existingUser = data.results.find(u => u["Username"] === mobile);
    
    if (existingUser) {
      mobileValidation.style.display = 'flex';
      document.getElementById('mobileIcon').className = 'fas fa-times-circle mobile-invalid';
      document.getElementById('mobileText').textContent = 'Mobile number already registered';
      document.getElementById('mobileText').className = 'mobile-invalid';
      isMobileAvailable = false;
    } else {
      mobileValidation.style.display = 'flex';
      document.getElementById('mobileIcon').className = 'fas fa-check-circle mobile-valid';
      document.getElementById('mobileText').textContent = 'Mobile number is available';
      document.getElementById('mobileText').className = 'mobile-valid';
      isMobileAvailable = true;
    }
  } catch (error) {
    console.error("Error checking mobile number:", error);
    mobileValidation.style.display = 'none';
    isMobileAvailable = false;
  }
}

// Enter key support for forms
document.addEventListener('keydown', function(event) {
  // Login form enter key
  if (event.key === 'Enter' && document.getElementById('loginForm').classList.contains('visible')) {
    if (document.activeElement.id === 'mobile' || document.activeElement.id === 'password') {
      login();
    }
  }
  
  // Register form enter key
  if (event.key === 'Enter' && document.getElementById('registerForm').classList.contains('visible')) {
    const activeElement = document.activeElement;
    const registerFields = ['rname', 'rmobile', 'rshopname', 'raddress', 'rpassword', 'rconfirmpassword'];
    if (registerFields.includes(activeElement.id)) {
      register();
    }
  }
});

// Show shop selection popup
function showShopSelectionPopup(users) {
  matchingUsers = users;
  const shopOptions = document.getElementById('shopOptions');
  shopOptions.innerHTML = '';
  
  // Create shop selection options
  users.forEach((user, index) => {
    // Parse shop name from the formatted string (ShopName-Address/Mobile)
    const shopInfo = parseShopInfo(user["Shop Name"]);
    
    const shopOption = document.createElement('div');
    shopOption.className = 'shop-option';
    shopOption.innerHTML = `
      <div class="shop-radio">
        <input type="radio" id="shop-${index}" name="shop" value="${user["ShopID"]}" ${index === 0 ? 'checked' : ''}>
      </div>
      <div class="shop-details">
        <div class="shop-name">${shopInfo.name}</div>
        <div class="shop-address">${shopInfo.address}</div>
      </div>
    `;
    
    shopOption.addEventListener('click', function() {
      document.querySelectorAll('.shop-option').forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      const radio = this.querySelector('input[type="radio"]');
      radio.checked = true;
      selectedShopId = radio.value;
    });
    
    shopOptions.appendChild(shopOption);
  });
  
  // Set the first shop as selected by default
  if (users.length > 0) {
    selectedShopId = users[0]["ShopID"];
    shopOptions.firstChild.classList.add('selected');
  }
  
  // Show the popup
  document.getElementById('shopSelectionPopup').classList.add('active');
}

// Parse shop information from the formatted string
function parseShopInfo(shopString) {
  // Format: ShopName-Address/Mobile
  const parts = shopString.split('-');
  const name = parts[0];
  
  let address = '';
  if (parts.length > 1) {
    const addressMobile = parts[1].split('/');
    address = addressMobile[0];
  }
  
  return { name, address };
}

// Confirm shop selection and proceed with login
function confirmShopSelection() {
  if (!selectedShopId) {
    alert('Please select a shop');
    return;
  }
  
  // Find the selected user
  const selectedUser = matchingUsers.find(user => user["ShopID"] === selectedShopId);
  
  if (selectedUser) {
    // Store user data and redirect
    localStorage.setItem("NameTag", selectedUser["Name"]);
    localStorage.setItem("ShopTag", selectedUser["Shop Name"]);
    localStorage.setItem("ShopIDTag", selectedUser["ShopID"]);
    localStorage.setItem("MobileTag", selectedUser["Username"]);
    localStorage.setItem("LastLogin", new Date().toISOString());
    localStorage.setItem("ActiveTime", Date.now());

    // Close the popup
    document.getElementById('shopSelectionPopup').classList.remove('active');
    
    // Redirect to dashboard
    window.location.href = "app.html";
  }
}

async function login() {
  const mobile = document.getElementById('mobile').value.trim();
  const password = document.getElementById('password').value.trim();
  const msg = document.getElementById('msg');
  const loginBtn = document.getElementById('loginBtn');
  const loginText = document.getElementById('loginText');
  
  msg.textContent = '';
  msg.className = 'notice';
  
  if (!mobile || !password) {
    msg.textContent = "Please enter all fields.";
    msg.className = 'notice error';
    return;
  }
  
  // Disable button and show spinner only (no text)
  loginBtn.disabled = true;
  loginText.innerHTML = '<div class="spinner"></div>';
  
  try {
    const res = await fetch(`${BASE_URL}${TABLE_ID}/?user_field_names=true`, {
      headers: { Authorization: `Token ${API_KEY}` }
    });
    const data = await res.json();

    // Find all users with this mobile number
    const users = data.results.filter(u => u["Username"] === mobile);
    
    if (users.length === 0) {
      msg.textContent = "Invalid mobile number or password.";
      msg.className = 'notice error';
      return;
    }

    // Check if any user is blocked
    const blockedUser = users.find(u => u["Block"]);
    if (blockedUser) {
      msg.textContent = `Blocked: ${blockedUser["Notice"] || "No notice provided"}`;
      msg.className = 'notice error';
      return;
    }

    // Check if password matches for any user
    const validUsers = users.filter(u => u["Password"] === password);
    
    if (validUsers.length === 0) {
      msg.textContent = "Invalid mobile number or password.";
      msg.className = 'notice error';
      return;
    }

    // If only one valid user, log them in directly
    if (validUsers.length === 1) {
      const user = validUsers[0];
      
      // Successful login
      localStorage.setItem("NameTag", user["Name"]);
      localStorage.setItem("ShopTag", user["Shop Name"]);
      localStorage.setItem("ShopIDTag", user["ShopID"]);
      localStorage.setItem("MobileTag", user["Username"]);
      localStorage.setItem("LastLogin", new Date().toISOString());
      localStorage.setItem("ActiveTime", Date.now());

      window.location.href = "app.html";
    } 
    // If multiple valid users with same password, show shop selection
    else {
      showShopSelectionPopup(validUsers);
    }
  } catch (error) {
    msg.textContent = "An error occurred. Please try again.";
    msg.className = 'notice error';
  } finally {
    // Re-enable button
    loginBtn.disabled = false;
    loginText.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
  }
}

async function register() {
  const name = document.getElementById('rname').value.trim();
  const role = document.getElementById('rrole').value;
  const shopname = document.getElementById('rshopname').value.trim();
  const address = document.getElementById('raddress').value.trim();
  const mobile = document.getElementById('rmobile').value.trim();
  const password = document.getElementById('rpassword').value.trim();
  const confirmPassword = document.getElementById('rconfirmpassword').value.trim();
  const rmsg = document.getElementById('rmsg');
  const registerBtn = document.getElementById('registerBtn');
  const registerText = document.getElementById('registerText');
  
  rmsg.textContent = '';
  rmsg.className = 'notice';
  
  if (!name || !shopname || !address || !mobile || !password || !confirmPassword) {
    rmsg.textContent = "Please fill all fields.";
    rmsg.className = 'notice error';
    return;
  }
  
  if (mobile.length !== 10 || isNaN(mobile)) {
    rmsg.textContent = "Enter valid 10-digit mobile number.";
    rmsg.className = 'notice error';
    return;
  }

  // Check if mobile number is available
  if (!isMobileAvailable) {
    rmsg.textContent = "This mobile number is already registered. Please use a different number.";
    rmsg.className = 'notice error';
    return;
  }

  // Validate password
  if (!validatePassword()) {
    rmsg.textContent = "Please ensure your password meets all requirements.";
    rmsg.className = 'notice error';
    return;
  }

  // Check if passwords match
  if (!checkPasswordMatch()) {
    rmsg.textContent = "Passwords do not match.";
    rmsg.className = 'notice error';
    return;
  }

  // Disable button and show spinner only (no text)
  registerBtn.disabled = true;
  registerText.innerHTML = '<div class="spinner"></div>';
  
  try {
    // Check duplicates - Check only by Username (mobile number)
    const res = await fetch(`${BASE_URL}${TABLE_ID}/?user_field_names=true`, {
      headers: { Authorization: `Token ${API_KEY}` }
    });
    const data = await res.json();
    
    // Check if mobile number already exists in Username column
    if (data.results.find(u => u["Username"] === mobile)) {
      rmsg.textContent = "This mobile number is already registered. Please use a different number.";
      rmsg.className = 'notice error';
      return;
    }

    const shopId = "SHOP-" + Date.now();
    
    // Create the formatted string: ShopName,Address/Username
    const formattedShopName = `${shopname}-${address}/${mobile}`;

    const createRes = await fetch(`${BASE_URL}${TABLE_ID}/?user_field_names=true`, {
      method: "POST",
      headers: {
        "Authorization": `Token ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        "Name": name,
        "Role": role,
        "Username": mobile,
        "Password": password,
        "ShopID": shopId,
        "Shop Name": formattedShopName,
        "Block": false,
        "Notice": "",
        "Last Login": new Date().toISOString()
      })
    });

    if (createRes.ok) {
      // Show success popup
      showPopup();
    } else {
      rmsg.textContent = "Registration failed. Try again.";
      rmsg.className = 'notice error';
    }
  } catch (error) {
    rmsg.textContent = "An error occurred. Please try again.";
    rmsg.className = 'notice error';
  } finally {
    // Re-enable button
    registerBtn.disabled = false;
    registerText.innerHTML = '<i class="fas fa-user-plus"></i> Register';
  }
}
</script>
</body>
</html>