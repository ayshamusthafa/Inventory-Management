<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Report Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --light: #f8f9fa;
      --dark: #212529;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --return: #e63946;
      --warranty: #f8961e;
      --replacement: #2a9d8f;
      --gray: #6c757d;
      --gray-light: #e9ecef;
      --border-radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      color: var(--dark);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }
    
    .dashboard-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 20px 25px;
      border-radius: var(--border-radius);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .dashboard-title {
      font-size: 24px;
      font-weight: 700;
    }
    
    .dashboard-subtitle {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .search-container {
      display: flex;
      max-width: 400px;
      flex: 1;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 18px;
      border-radius: var(--border-radius) 0 0 var(--border-radius);
      border: none;
      font-size: 15px;
      transition: var(--transition);
      background: rgba(255, 255, 255, 0.9);
    }
    
    .search-input:focus {
      outline: none;
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }
    
    .search-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 0 var(--border-radius) var(--border-radius) 0;
      background-color: var(--primary-dark);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .search-btn:hover {
      background-color: #2f4fcc;
    }
    
    .filters-section {
      background: white;
      padding: 20px 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 25px;
    }
    
    .filters-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      align-items: end;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-label {
      font-weight: 600;
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .filter-input {
      padding: 10px 14px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      font-size: 14px;
      transition: var(--transition);
      background: var(--light);
    }
    
    .filter-input:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    }
    
    .filter-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      height: fit-content;
    }
    
    .filter-btn:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(67, 97, 238, 0.3);
    }
    
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      text-align: center;
      transition: var(--transition);
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
    }
    
    .stat-icon {
      font-size: 28px;
      margin-bottom: 12px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .stat-value {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray);
      font-weight: 500;
    }
    
    .card-total .stat-icon {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }
    
    .card-invoices .stat-icon {
      background: rgba(73, 144, 226, 0.1);
      color: var(--info);
    }
    
    .card-products .stat-icon {
      background: rgba(76, 201, 240, 0.1);
      color: var(--success);
    }
    
    .card-average .stat-icon {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning);
    }
    
    .trends-section {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 1024px) {
      .trends-section {
        grid-template-columns: 1fr;
      }
    }
    
    .trend-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .trend-header {
      padding: 18px 22px;
      background: var(--light);
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .trend-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .trend-content {
      padding: 20px;
    }
    
    .trend-chart {
      height: 300px;
      display: flex;
      align-items: flex-end;
      gap: 10px;
      padding: 20px 0;
    }
    
    .trend-bar {
      flex: 1;
      background: linear-gradient(to top, var(--primary) 0%, var(--secondary) 100%);
      border-radius: 4px 4px 0 0;
      position: relative;
      transition: var(--transition);
    }
    
    .trend-bar:hover {
      opacity: 0.8;
    }
    
    .trend-label {
      position: absolute;
      bottom: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      color: var(--gray);
    }
    
    .trend-value {
      position: absolute;
      top: -25px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .product-trend-list {
      list-style: none;
    }
    
    .product-trend-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .product-trend-item:last-child {
      border-bottom: none;
    }
    
    .product-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .product-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
    }
    
    .product-name {
      font-weight: 500;
    }
    
    .product-stats {
      text-align: right;
    }
    
    .product-sales {
      font-weight: 600;
      font-size: 15px;
    }
    
    .product-growth {
      font-size: 12px;
      color: var(--success);
    }
    
    .product-decline {
      font-size: 12px;
      color: var(--danger);
    }
    
    .tables-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 1024px) {
      .tables-section {
        grid-template-columns: 1fr;
      }
    }
    
    .table-container {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .table-header {
      padding: 18px 22px;
      background: var(--light);
      border-bottom: 1px solid var(--gray-light);
    }
    
    .table-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .table-content {
      padding: 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table thead {
      background: var(--light);
      position: sticky;
      top: 0;
    }
    
    .data-table th {
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      color: var(--gray);
      border-bottom: 1px solid var(--gray-light);
    }
    
    .data-table td {
      padding: 12px;
      border-bottom: 1px solid var(--gray-light);
      font-size: 13px;
    }
    
    .data-table tbody tr {
      transition: var(--transition);
    }
    
    .data-table tbody tr:hover {
      background: rgba(67, 97, 238, 0.03);
    }
    
    .data-table tbody tr:last-child td {
      border-bottom: none;
    }
    
    .expandable-row {
      cursor: pointer;
    }
    
    .expandable-row:hover {
      background: rgba(67, 97, 238, 0.05) !important;
    }
    
    .batch-details {
      background: #f8f9fa;
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .batch-details.expanded {
      max-height: 500px;
      padding: 15px;
    }
    
    .batch-container {
      max-height: 400px;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    .batch-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .batch-container::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    .batch-container::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    .batch-container::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    .batch-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .batch-table th {
      background: #e9ecef;
      padding: 10px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: var(--gray);
      position: sticky;
      top: 0;
    }
    
    .batch-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #dee2e6;
      font-size: 12px;
    }
    
    .batch-table tr:last-child td {
      border-bottom: none;
    }
    
    .invoice-link {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .invoice-link:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }
    
    .expand-icon {
      transition: transform 0.3s ease;
      margin-right: 8px;
    }
    
    .expanded .expand-icon {
      transform: rotate(90deg);
    }
    
    .tag {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .tag-return {
      background-color: rgba(230, 57, 70, 0.1);
      color: var(--return);
      border: 1px solid var(--return);
    }
    
    .tag-warranty {
      background-color: rgba(248, 150, 30, 0.1);
      color: var(--warranty);
      border: 1px solid var(--warranty);
    }
    
    .tag-replacement {
      background-color: rgba(42, 157, 143, 0.1);
      color: var(--replacement);
      border: 1px solid var(--replacement);
    }
    
    .tag-none {
      background-color: rgba(108, 117, 125, 0.1);
      color: var(--gray);
      border: 1px solid var(--gray);
    }
    
    .view-btn {
      padding: 6px 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .view-btn:hover {
      background: var(--primary-dark);
    }
    
    .edit-btn {
      padding: 6px 12px;
      background: var(--warning);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      margin-left: 5px;
    }
    
    .edit-btn:hover {
      background: #e07c0c;
    }
    
    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
      font-style: italic;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      width: 90%;
      max-width: 600px;
      padding: 25px;
      animation: modalFadeIn 0.3s ease;
    }
    
    .invoice-modal-content {
      width: 95%;
      max-width: 1000px;
      height: 90vh;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    
    .alert-modal-content {
      max-width: 450px;
      text-align: center;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 18px 22px;
      background: var(--light);
      border-bottom: 1px solid var(--gray-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      color: var(--gray);
      transition: var(--transition);
    }
    
    .close-btn:hover {
      color: var(--dark);
    }
    
    .modal-body {
      flex: 1;
      padding: 0;
      overflow: hidden;
    }
    
    .invoice-iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 0 0 var(--border-radius) var(--border-radius);
    }
    
    .form-group {
      margin-bottom: 18px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    .form-select {
      width: 100%;
      padding: 10px 14px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      font-size: 14px;
      transition: var(--transition);
      background: var(--light);
    }
    
    .form-select:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    }
    
    .form-textarea {
      width: 100%;
      padding: 10px 14px;
      border-radius: var(--border-radius);
      border: 2px solid var(--gray-light);
      font-size: 14px;
      transition: var(--transition);
      background: var(--light);
      resize: vertical;
      min-height: 90px;
      font-family: inherit;
    }
    
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.1);
    }
    
    .product-selection {
      margin-bottom: 20px;
    }
    
    .product-option {
      display: flex;
      align-items: center;
      padding: 12px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius);
      margin-bottom: 10px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .product-option:hover {
      background: var(--light);
      border-color: var(--primary);
    }
    
    .product-option.selected {
      background: rgba(67, 97, 238, 0.05);
      border-color: var(--primary);
    }
    
    .product-option input {
      margin-right: 12px;
    }
    
    .product-details {
      flex: 1;
    }
    
    .product-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .product-info {
      font-size: 12px;
      color: var(--gray);
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 22px;
    }
    
    .cancel-btn {
      padding: 10px 20px;
      border: 2px solid var(--gray-light);
      border-radius: var(--border-radius);
      background: white;
      color: var(--gray);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .cancel-btn:hover {
      background: var(--gray-light);
      color: var(--dark);
    }
    
    .save-btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .save-btn:hover {
      background-color: var(--primary-dark);
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .alert-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      color: var(--success);
    }
    
    .alert-error {
      color: var(--danger);
    }
    
    .alert-warning {
      color: var(--warning);
    }
    
    .alert-info {
      color: var(--info);
    }
    
    .alert-message {
      margin-bottom: 25px;
      font-size: 16px;
      line-height: 1.5;
    }
    
    .alert-actions {
      display: flex;
      justify-content: center;
      gap: 12px;
    }
    
    .ok-btn {
      padding: 10px 24px;
      border: none;
      border-radius: var(--border-radius);
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .ok-btn:hover {
      background-color: var(--primary-dark);
    }
    
    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .search-container {
        max-width: 100%;
      }
      
      .filters-container {
        grid-template-columns: 1fr;
      }
      
      .stats-section {
        grid-template-columns: 1fr;
      }
      
      .data-table {
        display: block;
        overflow-x: auto;
      }
      
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      
      .invoice-modal-content {
        width: 98%;
        height: 85vh;
      }
      
      .batch-container {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>

  <div class="dashboard-container">
    <div class="dashboard-header">
      <div class="header-left">
        <div>
          <div class="dashboard-title">Sales Report Dashboard</div>
          <div class="dashboard-subtitle">Track and analyze your sales performance</div>
        </div>
      </div>
      <div class="search-container">
        <input type="text" id="invoiceSearch" class="search-input" placeholder="Search by invoice number...">
        <button class="search-btn" id="searchInvoiceBtn">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>

    <div class="filters-section">
      <div class="filters-container">
        <div class="filter-group">
          <div class="filter-label">Date Range</div>
          <input type="date" id="startDate" class="filter-input">
        </div>
        <div class="filter-group">
          <div class="filter-label">To</div>
          <input type="date" id="endDate" class="filter-input">
        </div>
        <div class="filter-group">
          <div class="filter-label">Sales Person</div>
          <select id="salesPerson" class="filter-input">
            <option value="">All Sales Persons</option>
          </select>
        </div>
        <div class="filter-group">
          <div class="filter-label">Product</div>
          <select id="productFilter" class="filter-input">
            <option value="">All Products</option>
          </select>
        </div>
        <div class="filter-group">
          <div class="filter-label">Tag</div>
          <select id="tagFilter" class="filter-input">
            <option value="">All Tags</option>
            <option value="Return">Return</option>
            <option value="Warranty">Warranty</option>
            <option value="Replacement">Replacement</option>
            <option value="None">None</option>
          </select>
        </div>
        <button class="filter-btn" id="applyFilters">
          <i class="fas fa-filter"></i> Apply Filters
        </button>
      </div>
    </div>

    <div class="stats-section">
      <div class="stat-card card-total">
        <div class="stat-icon">
          <i class="fas fa-rupee-sign"></i>
        </div>
        <div class="stat-value" id="totalSales">₹0.00</div>
        <div class="stat-label">Total Sales Value</div>
      </div>
      <div class="stat-card card-invoices">
        <div class="stat-icon">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="stat-value" id="totalInvoices">0</div>
        <div class="stat-label">Total Invoices</div>
      </div>
      <div class="stat-card card-products">
        <div class="stat-icon">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-value" id="totalProducts">0</div>
        <div class="stat-label">Products Sold</div>
      </div>
      <div class="stat-card card-average">
        <div class="stat-icon">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="stat-value" id="averageInvoice">₹0.00</div>
        <div class="stat-label">Average Invoice Value</div>
      </div>
    </div>

    <div class="trends-section">
      <div class="trend-card">
        <div class="trend-header">
          <div class="trend-title">Sales Trends (Last 7 Days)</div>
          <div>
            <i class="fas fa-chart-line"></i>
          </div>
        </div>
        <div class="trend-content">
          <div class="trend-chart" id="salesTrendChart">
            <!-- Chart bars will be generated here -->
          </div>
        </div>
      </div>
      
      <div class="trend-card">
        <div class="trend-header">
          <div class="trend-title">Top Products</div>
          <div>
            <i class="fas fa-star"></i>
          </div>
        </div>
        <div class="trend-content">
          <ul class="product-trend-list" id="topProductsList">
            <!-- Top products will be listed here -->
          </ul>
        </div>
      </div>
    </div>

    <div class="tables-section">
      <div class="table-container">
        <div class="table-header">
          <div class="table-title">Recent Invoices</div>
        </div>
        <div class="table-content">
          <table class="data-table" id="invoicesTable">
            <thead>
              <tr>
                <th>Invoice No.</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Amount</th>
                <th>Tag</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="invoicesTableBody">
              <!-- Invoice data will be populated here -->
            </tbody>
          </table>
          <div id="noInvoices" class="no-data" style="display: none;">No invoices found for the selected filters</div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <div class="table-title">Product Summary</div>
        </div>
        <div class="table-content">
          <table class="data-table" id="productsTable">
            <thead>
              <tr>
                <th></th>
                <th>Product Name</th>
                <th>Product ID</th>
                <th>Quantity</th>
                <th>Total Value</th>
              </tr>
            </thead>
            <tbody id="productsTableBody">
              <!-- Product summary data will be populated here -->
            </tbody>
          </table>
          <div id="noProducts" class="no-data" style="display: none;">No product data available</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Tag Modal -->
  <div class="modal" id="editTagModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Update Invoice Tag</div>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <div class="form-label">Invoice Number</div>
          <div id="modalInvoiceNumber" class="filter-input" style="background: #f0f0f0;">INV123456</div>
        </div>
        
        <div class="product-selection" id="productSelection">
          <div class="form-label">Select Products to Update</div>
          <!-- Product options will be dynamically added here -->
        </div>
        
        <div class="form-group">
          <div class="form-label">Tag</div>
          <select id="tagSelect" class="form-select">
            <option value="None">None</option>
            <option value="Return">Return</option>
            <option value="Warranty">Warranty</option>
            <option value="Replacement">Replacement</option>
          </select>
        </div>
        <div class="form-group">
          <div class="form-label">Remark</div>
          <textarea id="remarkText" class="form-textarea" placeholder="Enter remark for this tag update..."></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="cancel-btn" id="cancelEdit">Cancel</button>
        <button class="save-btn" id="saveTag">Update Tag</button>
      </div>
    </div>
  </div>

  <!-- Invoice View Modal -->
  <div class="modal" id="invoiceModal">
    <div class="modal-content invoice-modal-content">
      <div class="modal-header">
        <div class="modal-title" id="invoiceModalTitle">Invoice Details</div>
        <button class="close-btn" id="closeInvoiceModal">&times;</button>
      </div>
      <div class="modal-body">
        <iframe id="invoiceIframe" class="invoice-iframe" src=""></iframe>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div class="modal" id="alertModal">
    <div class="modal-content alert-modal-content">
      <div class="modal-body" style="padding: 30px 25px;">
        <div class="alert-icon" id="alertIcon">
          <i class="fas fa-info-circle alert-info"></i>
        </div>
        <div class="alert-message" id="alertMessage">This is an alert message.</div>
        <div class="alert-actions">
          <button class="ok-btn" id="alertOkBtn">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiKey = "jXXkrUUqrQK3RlESaDPs2gq0Eu0SK4Sw";
    const salesTableId = 736209;
    const productTableId = 734793;

    const salesUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/?user_field_names=true`;
    const productUrl = `https://api.baserow.io/api/database/rows/table/${productTableId}/?user_field_names=true`;

    // Global variables
    let currentInvoiceData = [];
    let currentEditingInvoice = null;
    let expandedProducts = new Set();
    let selectedProducts = new Set();

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Set default date range (last 30 days)
      setDefaultDateRange();
      
      // Load initial data
      loadSalesData();
      
      // Set up event listeners
      document.getElementById('applyFilters').addEventListener('click', loadSalesData);
      document.getElementById('searchInvoiceBtn').addEventListener('click', searchInvoice);
      document.getElementById('invoiceSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchInvoice();
      });
      
      // Modal event listeners
      document.getElementById('closeModal').addEventListener('click', closeModal);
      document.getElementById('cancelEdit').addEventListener('click', closeModal);
      document.getElementById('saveTag').addEventListener('click', updateInvoiceTag);
      
      // Invoice modal event listeners
      document.getElementById('closeInvoiceModal').addEventListener('click', closeInvoiceModal);
      
      // Alert modal event listeners
      document.getElementById('alertOkBtn').addEventListener('click', closeAlertModal);
    });

    function setDefaultDateRange() {
      const endDate = new Date();
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - 30);
      
      document.getElementById('startDate').valueAsDate = startDate;
      document.getElementById('endDate').valueAsDate = endDate;
    }

    function formatDate(dateString) {
      if (!dateString) return "N/A";
      
      try {
        // Try to parse the date string
        const date = new Date(dateString);
        
        // Check if date is valid
        if (isNaN(date.getTime())) {
          return dateString; // Return original if invalid
        }
        
        // Format as DD/MM/YYYY
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}/${month}/${year}`;
      } catch (error) {
        console.error("Date formatting error:", error);
        return dateString; // Return original if error
      }
    }

    function formatCurrency(amount) {
      return '₹' + parseFloat(amount).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    function getTagClass(tag) {
      if (!tag || tag === "None") return "tag-none";
      return `tag-${tag.toLowerCase()}`;
    }

    function getTagDisplayName(tag) {
      if (!tag || tag === "None") return "None";
      return tag;
    }

    function getProductIcon(productId) {
      // Assign icons based on product ID or category
      const icons = [
        'fa-mobile-alt', 'fa-laptop', 'fa-headphones', 'fa-tablet-alt', 
        'fa-tv', 'fa-camera', 'fa-gamepad', 'fa-clock'
      ];
      const index = productId ? productId.charCodeAt(0) % icons.length : 0;
      return icons[index];
    }

    function getProductColor(productId) {
      // Assign colors based on product ID
      const colors = [
        '#4361ee', '#7209b7', '#f72585', '#4cc9f0',
        '#4895ef', '#3a0ca3', '#f8961e', '#2a9d8f'
      ];
      const index = productId ? productId.charCodeAt(0) % colors.length : 0;
      return colors[index];
    }

    // Extract numeric part from invoice number
    function extractInvoiceNumber(invoiceString) {
      if (!invoiceString) return 0;
      
      // Remove "INV" prefix and any non-numeric characters
      const numericPart = invoiceString.replace(/^INV/, '').replace(/\D/g, '');
      
      // Convert to a number (BigInt for very large numbers)
      return numericPart ? BigInt(numericPart) : 0n;
    }

    // Show alert modal instead of native alert
    function showAlert(message, type = 'info') {
      const alertModal = document.getElementById('alertModal');
      const alertIcon = document.getElementById('alertIcon');
      const alertMessage = document.getElementById('alertMessage');
      
      // Set icon based on type
      let iconClass = 'fas fa-info-circle alert-info';
      switch(type) {
        case 'success':
          iconClass = 'fas fa-check-circle alert-success';
          break;
        case 'error':
          iconClass = 'fas fa-exclamation-circle alert-error';
          break;
        case 'warning':
          iconClass = 'fas fa-exclamation-triangle alert-warning';
          break;
        default:
          iconClass = 'fas fa-info-circle alert-info';
      }
      
      alertIcon.innerHTML = `<i class="${iconClass}"></i>`;
      alertMessage.textContent = message;
      
      alertModal.style.display = 'flex';
    }

    function closeAlertModal() {
      document.getElementById('alertModal').style.display = 'none';
    }

    async function loadSalesData() {
      const shopIDTag = localStorage.getItem("ShopIDTag");
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;
      const salesPerson = document.getElementById("salesPerson").value;
      const productFilter = document.getElementById("productFilter").value;
      const tagFilter = document.getElementById("tagFilter").value;
      const applyBtn = document.getElementById("applyFilters");

      // Show loading state
      applyBtn.disabled = true;
      applyBtn.innerHTML = '<span class="loading"></span> Loading...';

      if (!shopIDTag) {
        showAlert("ShopIDTag not found in local storage. Please log in first.", "error");
        applyBtn.disabled = false;
        applyBtn.innerHTML = '<i class="fas fa-filter"></i> Apply Filters';
        return;
      }

      try {
        // Fetch Product Table for mapping
        const productResponse = await fetch(productUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        const productData = await productResponse.json();

        // Fetch Sales Table
        const salesResponse = await fetch(salesUrl, {
          headers: { Authorization: `Token ${apiKey}` }
        });
        const salesData = await salesResponse.json();

        // Filter sales data based on criteria
        let filteredSales = salesData.results.filter(row => row["ShopID"] === shopIDTag);

        // Apply date filter
        if (startDate && endDate) {
          filteredSales = filteredSales.filter(row => {
            const saleDate = new Date(row["Date"]);
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999); // Include the entire end date
            
            return saleDate >= start && saleDate <= end;
          });
        }

        // Apply sales person filter
        if (salesPerson) {
          filteredSales = filteredSales.filter(row => row["Sales Person"] === salesPerson);
        }

        // Apply product filter
        if (productFilter) {
          filteredSales = filteredSales.filter(row => row["Product ID"] === productFilter);
        }

        // Apply tag filter
        if (tagFilter && tagFilter !== "None") {
          filteredSales = filteredSales.filter(row => row["Tag"] === tagFilter);
        } else if (tagFilter === "None") {
          filteredSales = filteredSales.filter(row => !row["Tag"] || row["Tag"] === "None");
        }

        // Store current data for later use
        currentInvoiceData = filteredSales;

        // Process data for display
        processSalesData(filteredSales, productData);

      } catch (error) {
        console.error(error);
        showAlert("Error fetching data. Please try again.", "error");
      } finally {
        applyBtn.disabled = false;
        applyBtn.innerHTML = '<i class="fas fa-filter"></i> Apply Filters';
      }
    }

    function processSalesData(salesData, productData) {
      // Group by invoice number to get unique invoices
      const invoicesMap = {};
      const productsMap = {};
      const productBatchMap = {};
      const dailySales = {};
      
      let totalSalesValue = 0;
      let totalProductsSold = 0;

      // Initialize last 7 days
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days.push(dateStr);
        dailySales[dateStr] = 0;
      }

      salesData.forEach(row => {
        const invoiceNumber = row["Invoice Number"];
        const productId = row["Product ID"];
        const batchNo = row["Batch No"] || "N/A";
        const quantity = Number(row["Quantity"]) || 0;
        const price = Number(row["Price"]) || 0;
        const total = quantity * price;
        const saleDate = new Date(row["Date"]).toISOString().split('T')[0];
        
        // Add to daily sales
        if (dailySales.hasOwnProperty(saleDate)) {
          dailySales[saleDate] += total;
        }
        
        // Process invoice data
        if (!invoicesMap[invoiceNumber]) {
          invoicesMap[invoiceNumber] = {
            invoiceNumber: invoiceNumber,
            numericInvoiceNumber: extractInvoiceNumber(invoiceNumber),
            date: row["Date"],
            customer: row["Costomer Name"],
            total: 0,
            salesPerson: row["Sales Person"],
            tag: row["Tag"] || "None",
            remark: row["Remark"] || ""
          };
        }
        invoicesMap[invoiceNumber].total += total;
        
        // Process product data
        if (!productsMap[productId]) {
          const product = productData.results.find(p => p["Product ID"] === productId);
          productsMap[productId] = {
            productId: productId,
            productName: product ? product["Product Name"] : "Unknown Product",
            quantity: 0,
            total: 0,
            batches: {}
          };
        }
        productsMap[productId].quantity += quantity;
        productsMap[productId].total += total;
        
        // Process batch data
        if (!productsMap[productId].batches[batchNo]) {
          productsMap[productId].batches[batchNo] = {
            batchNo: batchNo,
            quantity: 0,
            total: 0,
            invoices: []
          };
        }
        productsMap[productId].batches[batchNo].quantity += quantity;
        productsMap[productId].batches[batchNo].total += total;
        productsMap[productId].batches[batchNo].invoices.push({
          invoiceNumber: invoiceNumber,
          date: row["Date"],
          quantity: quantity,
          price: price,
          total: total,
          rowId: row.id, // Store the row ID for updates
          tag: row["Tag"] || "None",
          remark: row["Remark"] || ""
        });
        
        // Update totals
        totalSalesValue += total;
        totalProductsSold += quantity;
      });

      // Convert maps to arrays and sort by numeric invoice number (descending)
      const invoices = Object.values(invoicesMap)
        .sort((a, b) => {
          // Compare BigInt values for proper numeric sorting
          if (a.numericInvoiceNumber > b.numericInvoiceNumber) return -1;
          if (a.numericInvoiceNumber < b.numericInvoiceNumber) return 1;
          return 0;
        });
      
      const products = Object.values(productsMap)
        .sort((a, b) => b.total - a.total); // Highest value first

      // Update statistics
      updateStatistics(invoices, totalSalesValue, totalProductsSold);
      
      // Update tables
      updateInvoicesTable(invoices);
      updateProductsTable(products, productsMap);
      
      // Update trends
      updateSalesTrends(dailySales, last7Days);
      updateTopProducts(products);
      
      // Update filter dropdowns
      updateFilterDropdowns(salesData, productData);
    }

    function updateStatistics(invoices, totalSalesValue, totalProductsSold) {
      document.getElementById("totalSales").textContent = formatCurrency(totalSalesValue);
      document.getElementById("totalInvoices").textContent = invoices.length;
      document.getElementById("totalProducts").textContent = totalProductsSold;
      
      const averageInvoice = invoices.length > 0 ? totalSalesValue / invoices.length : 0;
      document.getElementById("averageInvoice").textContent = formatCurrency(averageInvoice);
    }

    function updateSalesTrends(dailySales, last7Days) {
      const chartContainer = document.getElementById('salesTrendChart');
      chartContainer.innerHTML = '';
      
      // Find the maximum sales value for scaling
      const maxSales = Math.max(...Object.values(dailySales));
      
      last7Days.forEach(day => {
        const sales = dailySales[day] || 0;
        const height = maxSales > 0 ? (sales / maxSales) * 100 : 0;
        
        const bar = document.createElement('div');
        bar.className = 'trend-bar';
        bar.style.height = `${height}%`;
        
        const value = document.createElement('div');
        value.className = 'trend-value';
        value.textContent = formatCurrency(sales);
        
        const label = document.createElement('div');
        label.className = 'trend-label';
        label.textContent = new Date(day).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        bar.appendChild(value);
        bar.appendChild(label);
        chartContainer.appendChild(bar);
      });
    }

    function updateTopProducts(products) {
      const topProductsList = document.getElementById('topProductsList');
      topProductsList.innerHTML = '';
      
      // Take top 5 products
      const topProducts = products.slice(0, 5);
      
      if (topProducts.length === 0) {
        topProductsList.innerHTML = '<div class="no-data">No product data available</div>';
        return;
      }
      
      topProducts.forEach(product => {
        const listItem = document.createElement('li');
        listItem.className = 'product-trend-item fade-in';
        
        const growth = Math.random() > 0.3; // Random growth/decline for demo
        
        listItem.innerHTML = `
          <div class="product-info">
            <div class="product-icon" style="background: ${getProductColor(product.productId)}">
              <i class="fas ${getProductIcon(product.productId)}"></i>
            </div>
            <div class="product-name">${product.productName}</div>
          </div>
          <div class="product-stats">
            <div class="product-sales">${formatCurrency(product.total)}</div>
            <div class="${growth ? 'product-growth' : 'product-decline'}">
              <i class="fas ${growth ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
              ${(Math.random() * 20).toFixed(1)}%
            </div>
          </div>
        `;
        
        topProductsList.appendChild(listItem);
      });
    }

    function updateInvoicesTable(invoices) {
      const tableBody = document.getElementById("invoicesTableBody");
      const noDataMsg = document.getElementById("noInvoices");
      
      tableBody.innerHTML = "";
      
      if (invoices.length === 0) {
        noDataMsg.style.display = "block";
        return;
      }
      
      noDataMsg.style.display = "none";
      
      invoices.forEach(invoice => {
        const row = document.createElement("tr");
        row.classList.add("fade-in");
        row.innerHTML = `
          <td>${invoice.invoiceNumber}</td>
          <td>${formatDate(invoice.date)}</td>
          <td>${invoice.customer}</td>
          <td>${formatCurrency(invoice.total)}</td>
          <td><span class="tag ${getTagClass(invoice.tag)}">${getTagDisplayName(invoice.tag)}</span></td>
          <td>
            <button class="view-btn" onclick="viewInvoiceInModal('${invoice.invoiceNumber}')">View</button>
            <button class="edit-btn" onclick="openEditModal('${invoice.invoiceNumber}')">Edit Tag</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function updateProductsTable(products, productsMap) {
      const tableBody = document.getElementById("productsTableBody");
      const noDataMsg = document.getElementById("noProducts");
      
      tableBody.innerHTML = "";
      
      if (products.length === 0) {
        noDataMsg.style.display = "block";
        return;
      }
      
      noDataMsg.style.display = "none";
      
      products.forEach(product => {
        const isExpanded = expandedProducts.has(product.productId);
        
        const row = document.createElement("tr");
        row.className = `expandable-row ${isExpanded ? 'expanded' : ''}`;
        row.setAttribute('data-product-id', product.productId);
        
        row.innerHTML = `
          <td>
            <i class="fas fa-chevron-right expand-icon"></i>
          </td>
          <td>${product.productName}</td>
          <td>${product.productId}</td>
          <td>${product.quantity}</td>
          <td>${formatCurrency(product.total)}</td>
        `;
        
        tableBody.appendChild(row);
        
        // Add batch details row
        const batchRow = document.createElement("tr");
        batchRow.className = "batch-row";
        
        const batchCell = document.createElement("td");
        batchCell.colSpan = 6;
        batchCell.className = "batch-cell";
        
        const batchDetails = document.createElement("div");
        batchDetails.className = `batch-details ${isExpanded ? 'expanded' : ''}`;
        batchDetails.id = `batch-details-${product.productId}`;
        
        if (isExpanded) {
          batchDetails.innerHTML = generateBatchDetailsHTML(product, productsMap[product.productId].batches);
        }
        
        batchCell.appendChild(batchDetails);
        batchRow.appendChild(batchCell);
        tableBody.appendChild(batchRow);
        
        // Add click event to expand/collapse
        row.addEventListener('click', function() {
          toggleProductExpansion(product.productId, product, productsMap[product.productId].batches);
        });
      });
    }

    function generateBatchDetailsHTML(product, batches) {
      let html = `
        <h4 style="margin-bottom: 15px; color: var(--primary);">Batch-wise Report for ${product.productName}</h4>
        <div class="batch-container">
      `;
      
      // Sort batches by total value (descending)
      const sortedBatches = Object.values(batches).sort((a, b) => b.total - a.total);
      
      sortedBatches.forEach(batch => {
        html += `
          <div style="margin-bottom: 20px; border: 1px solid var(--gray-light); border-radius: 8px; overflow: hidden;">
            <div style="background: var(--light); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 600;">Batch No: ${batch.batchNo}</div>
              <div style="font-weight: 600;">Total: ${formatCurrency(batch.total)}</div>
            </div>
            <table class="batch-table">
              <thead>
                <tr>
                  <th>Invoice No.</th>
                  <th>Date</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Total</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        // Sort invoices by numeric invoice number (descending)
        const sortedInvoices = batch.invoices.sort((a, b) => {
          const aNum = extractInvoiceNumber(a.invoiceNumber);
          const bNum = extractInvoiceNumber(b.invoiceNumber);
          if (aNum > bNum) return -1;
          if (aNum < bNum) return 1;
          return 0;
        });
        
        sortedInvoices.forEach(invoice => {
          html += `
            <tr>
              <td>
                <span class="invoice-link" onclick="viewInvoiceInModal('${invoice.invoiceNumber}')">
                  ${invoice.invoiceNumber}
                </span>
              </td>
              <td>${formatDate(invoice.date)}</td>
              <td>${invoice.quantity}</td>
              <td>${formatCurrency(invoice.price)}</td>
              <td>${formatCurrency(invoice.total)}</td>
              <td>
                <button class="view-btn" onclick="viewInvoiceInModal('${invoice.invoiceNumber}')">
                  <i class="fas fa-eye"></i> View
                </button>
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
              <tfoot>
                <tr style="background: #f8f9fa; font-weight: 600;">
                  <td colspan="2" style="text-align: right;">Batch Total:</td>
                  <td>${batch.quantity}</td>
                  <td></td>
                  <td>${formatCurrency(batch.total)}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;
      });
      
      html += `</div>`; // Close batch-container
      
      return html;
    }

    function toggleProductExpansion(productId, product, batches) {
      const batchDetails = document.getElementById(`batch-details-${productId}`);
      const productRow = document.querySelector(`tr[data-product-id="${productId}"]`);
      
      if (expandedProducts.has(productId)) {
        // Collapse
        expandedProducts.delete(productId);
        batchDetails.classList.remove('expanded');
        productRow.classList.remove('expanded');
        
        // Clear content after animation
        setTimeout(() => {
          if (!expandedProducts.has(productId)) {
            batchDetails.innerHTML = '';
          }
        }, 300);
      } else {
        // Expand
        expandedProducts.add(productId);
        batchDetails.innerHTML = generateBatchDetailsHTML(product, batches);
        
        // Trigger animation
        setTimeout(() => {
          batchDetails.classList.add('expanded');
          productRow.classList.add('expanded');
        }, 10);
      }
    }

    function updateFilterDropdowns(salesData, productData) {
      // Update sales person dropdown
      const salesPersonSelect = document.getElementById("salesPerson");
      const salesPersons = [...new Set(salesData.map(row => row["Sales Person"]))].filter(Boolean);
      
      // Clear existing options except the first one
      while (salesPersonSelect.options.length > 1) {
        salesPersonSelect.remove(1);
      }
      
      // Add new options
      salesPersons.forEach(person => {
        const option = document.createElement("option");
        option.value = person;
        option.textContent = person;
        salesPersonSelect.appendChild(option);
      });
      
      // Update product filter dropdown
      const productSelect = document.getElementById("productFilter");
      const products = [...new Set(salesData.map(row => row["Product ID"]))].filter(Boolean);
      
      // Clear existing options except the first one
      while (productSelect.options.length > 1) {
        productSelect.remove(1);
      }
      
      // Add new options
      products.forEach(productId => {
        const product = productData.results.find(p => p["Product ID"] === productId);
        const productName = product ? product["Product Name"] : productId;
        
        const option = document.createElement("option");
        option.value = productId;
        option.textContent = productName;
        productSelect.appendChild(option);
      });
    }

    function searchInvoice() {
      const invoiceNumber = document.getElementById('invoiceSearch').value.trim();
      
      if (!invoiceNumber) {
        showAlert('Please enter an invoice number to search', 'warning');
        return;
      }
      
      // Check if the invoice exists in current data
      const invoiceExists = currentInvoiceData.some(row => row["Invoice Number"] === invoiceNumber);
      
      if (invoiceExists) {
        // Open the Edit Tag modal with the invoice number
        openEditModal(invoiceNumber);
      } else {
        // Show error message
        showAlert(`Invoice "${invoiceNumber}" not found in the current data. Please check the invoice number or adjust your filters.`, 'error');
      }
    }

    function viewInvoiceInModal(invoiceNumber) {
      // Set modal title
      document.getElementById('invoiceModalTitle').textContent = `Invoice: ${invoiceNumber}`;
      
      // Set iframe source
      const iframe = document.getElementById('invoiceIframe');
      iframe.src = `invoice.html?invoice=${invoiceNumber}`;
      
      // Show modal
      document.getElementById('invoiceModal').style.display = 'flex';
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
      const iframe = document.getElementById('invoiceIframe');
      iframe.src = '';
    }

    function openEditModal(invoiceNumber) {
      // Find all products for this invoice
      const invoiceProducts = currentInvoiceData.filter(row => row["Invoice Number"] === invoiceNumber);
      
      if (invoiceProducts.length === 0) {
        showAlert("Invoice data not found", "error");
        return;
      }
      
      // Reset selected products
      selectedProducts.clear();
      
      // Populate modal fields
      document.getElementById("modalInvoiceNumber").textContent = invoiceNumber;
      
      // Create product selection options
      const productSelection = document.getElementById("productSelection");
      productSelection.innerHTML = `
        <div class="form-label">Select Products to Update</div>
      `;
      
      invoiceProducts.forEach((product, index) => {
        const productOption = document.createElement("div");
        productOption.className = "product-option";
        productOption.innerHTML = `
          <input type="checkbox" id="product-${index}" value="${product.id}" ${index === 0 ? 'checked' : ''}>
          <div class="product-details">
            <div class="product-name">${product["Product ID"]}</div>
            <div class="product-info">
              Quantity: ${product.Quantity} | Price: ${formatCurrency(product.Price)} | Total: ${formatCurrency(product.Quantity * product.Price)}
            </div>
          </div>
        `;
        
        // Add event listener to track selection
        const checkbox = productOption.querySelector('input');
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedProducts.add(this.value);
          } else {
            selectedProducts.delete(this.value);
          }
        });
        
        // Add to selected products if checked
        if (index === 0) {
          selectedProducts.add(product.id);
        }
        
        productSelection.appendChild(productOption);
      });
      
      // Set default tag and remark (use first product's values)
      document.getElementById("tagSelect").value = invoiceProducts[0]["Tag"] || "None";
      document.getElementById("remarkText").value = invoiceProducts[0]["Remark"] || "";
      
      // Clear the search input
      document.getElementById('invoiceSearch').value = '';
      
      // Show modal
      document.getElementById("editTagModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("editTagModal").style.display = "none";
      currentEditingInvoice = null;
      selectedProducts.clear();
    }

    async function updateInvoiceTag() {
      if (selectedProducts.size === 0) {
        showAlert("Please select at least one product to update", "warning");
        return;
      }
      
      const tag = document.getElementById("tagSelect").value;
      const remark = document.getElementById("remarkText").value;
      const saveBtn = document.getElementById("saveTag");
      
      // Show loading state
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> Updating...';
      
      try {
        // Update each selected product
        const updatePromises = Array.from(selectedProducts).map(async (rowId) => {
          // Prepare update data
          const updateData = {
            "Tag": tag,
            "Remark": remark
          };
          
          // Update the row in Baserow
          const updateUrl = `https://api.baserow.io/api/database/rows/table/${salesTableId}/${rowId}/?user_field_names=true`;
          
          const response = await fetch(updateUrl, {
            method: "PATCH",
            headers: {
              "Authorization": `Token ${apiKey}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify(updateData)
          });
          
          if (!response.ok) {
            throw new Error(`Failed to update product with ID: ${rowId}`);
          }
          
          return response;
        });
        
        // Wait for all updates to complete
        await Promise.all(updatePromises);
        
        showAlert(`Tag and remark updated successfully for ${selectedProducts.size} product(s)!`, "success");
        closeModal();
        // Reload data to reflect changes
        loadSalesData();
      } catch (error) {
        console.error(error);
        showAlert("Error updating tag. Please try again.", "error");
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = "Update Tag";
      }
    }
  </script>

</body>
</html>